# 設備綁定與移轉功能前端大綱

## 🎯 功能目標
- 在前端系統中，提供醫護人員 / 管理者操作介面，用於：
  1. **綁定設備** → 將特定硬體設備 (Tag, 300B, Pedo, Diaper DV1) 綁定至病患  
  2. **移轉 / 更換設備** → 將原有設備解除或轉換至其他病患，保留歷史紀錄  
- 確保訊號可以依病患整合，而不是依設備 ID。

---

## 🖼️ UI 流程與畫面

### 1. 病患設備管理頁面
- **病患列表**（左側欄或主表格）
  - 病患基本資訊（姓名、病歷號、床號）
  - 已綁定設備狀態（Tag / 300B / Pedo / Diaper）
- **操作按鈕**
  - 綁定新設備
  - 移轉 / 更換設備
  - 解除綁定（設備暫停使用）

### 2. 設備綁定流程
1. **選擇病患**
   - 在病患清單點選 → 打開「設備管理彈窗」
2. **輸入 / 掃描設備資訊**
   - 支援：
     - 手動輸入（MAC、id、serial no）
     - 掃描 QR code / 條碼
   - 自動生成 `device_uid`（後端規則：`<TYPE>:<MAC/id>`）
3. **選擇設備類型**
   - 下拉選單：`Tag / 300B / Pedo / Diaper`
4. **確認綁定**
   - 顯示：設備資訊 + 病患資訊 → 點擊「綁定」  
   - 成功後更新前端 UI 顯示已綁定的設備

### 3. 設備移轉 / 更換流程
1. **選取既有綁定**
   - 在病患設備列表中，點選要更換的設備
2. **選擇操作**
   - 「移轉至其他病患」 or 「更換新設備」
3. **移轉至其他病患**
   - 選擇目標病患
   - 自動將舊綁定 `end_time` 填入 → 在新病患建立新綁定紀錄
4. **更換新設備**
   - 輸入新設備資訊（同「設備綁定」流程）
   - 系統將舊設備設為「停用」並建立新綁定紀錄

---

## 📊 資料結構 (前端需呼叫 API)

### 綁定設備 API
```json
POST /api/patient/{patient_id}/devices
{
  "device_type": "300B",
  "native_id": "A1:B2:C3:D4:E5",
  "serial_no": "12345",
  "device_uid": "300B:A1B2C3D4E5"
}
```

### 移轉設備 API
```json
POST /api/device/{device_uid}/transfer
{
  "target_patient_id": "patient002"
}
```

### 更換設備 API
```json
POST /api/patient/{patient_id}/devices/replace
{
  "old_device_uid": "TAG:12345",
  "new_device_type": "TAG",
  "new_device_uid": "TAG:67890"
}
```

---

## 🔑 各設備唯一辨識欄位（依現有 JSON 格式）

| 設備類型 | 可唯一辨識欄位 | 備註 |
|----------|----------------|------|
| **Tag** | `id`、`serial no` | 建議使用 `id` 或 `id+serial no`，不可用 `gateway id` |
| **300B (穿戴手環)** | `MAC`、`serial no` | `MAC` 最穩定，必要時 `MAC+serial no` |
| **Diaper DV1** | `MAC`、`serial no` | `mssg idx` 是訊息序號，不適合做唯一鍵 |
| **Pedo** | `id`、`serial no` | 建議用 `id` 或 `id+serial no` |

👉 沒有跨設備共通的 ID，因此需要「設備 ↔ 病患」綁定設定，才能彙整病患訊號。  

---

## ✅ 驗證需求
- 綁定前需檢查 `device_uid` 是否已被其他病患使用（避免重複）
- 解除 / 移轉時，前端需顯示「確認提示」  
- 前端 UI 顯示需能清楚標記**有效綁定**與**歷史綁定**  

---

## 🚀 後續可擴充
- 支援批次綁定（一次為多位病患配發設備）
- 支援搜尋 / 過濾設備狀態（在庫 / 綁定中 / 維修中）
- QR code 掃描自動填寫 `device_uid`
