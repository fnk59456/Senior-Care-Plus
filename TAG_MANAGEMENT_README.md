# 標籤管理 - 自動加入系統功能說明

## 功能概述
標籤管理的自動加入系統功能允許系統自動將從雲端MQTT發現的標籤設備添加到本地系統中，實現標籤的統一管理和監控。系統會自動處理新標籤的加入和現有標籤信息的更新，無需用戶手動操作。

## 主要功能

### 1. 自動標籤發現
- **MQTT監聽**：自動監聽選定閘道器的"message"和"location"主題
- **實時解析**：解析標籤的電池電量、位置信息等數據
- **智能過濾**：只處理正確的"content"和"node"字段的數據

### 2. 自動加入系統
- **新標籤自動加入**：新發現的標籤自動創建並加入本地系統
- **現有標籤自動更新**：已存在的標籤自動更新狀態、電量、位置等信息
- **無需手動操作**：完全自動化，提升用戶體驗

### 3. 標籤類型
- **人員標籤**：統一使用"person"類型，簡化系統管理
- **自動命名**：新標籤自動命名為"標籤_[ID]"
- **智能狀態**：根據電池電量自動判斷標籤狀態

## 使用方法

### 1. 選擇閘道器
1. 在"標籤管理"分頁選擇養老院和樓層
2. 選擇要監聽的閘道器
3. 系統自動連接到對應的MQTT主題

### 2. 自動發現和加入
1. 系統自動監聽MQTT信號
2. 新標籤自動加入系統
3. 現有標籤信息自動更新
4. 無需手動點擊按鈕

### 3. 查看和管理
1. 在"雲端標籤發現"中查看發現的標籤
2. 在"本地標籤"中管理已加入系統的標籤
3. 標籤信息實時更新

## 數據映射

### 從雲端到本地的字段映射
- `id` → `id` (標籤唯一標識)
- `battery level` → `batteryLevel` (電池電量)
- `position` → `lastPosition` (最後位置)
- `time` → `timestamp` (時間戳)

### 默認設置
- **類型**：統一設為"person"（人員）
- **狀態**：根據電池電量自動判斷（>20%為active，≤20%為low_battery）
- **名稱**：自動生成為"標籤_[ID]"
- **MAC地址**：使用ID的十六進制表示或構建格式

## 界面元素

### 統計卡片
- **人員標籤**：顯示本地人員標籤數量
- **活躍中**：顯示當前活躍的標籤數量
- **雲端標籤**：顯示從雲端發現的標籤數量

### 標籤列表
- **雲端標籤發現**：顯示從MQTT發現的標籤
- **本地標籤**：顯示已加入系統的標籤
- **雲端標記**：標記來源於雲端發現的標籤

## 技術實現

### MQTT連接
- 自動連接到選定閘道器的MQTT主題
- 支持"message"和"location"兩種數據類型
- 智能重連和錯誤處理

### 數據處理
- 實時解析MQTT消息
- 自動更新本地標籤狀態
- 智能處理重複數據

### 狀態管理
- 使用React狀態管理標籤數據
- 自動同步雲端和本地數據
- 實時更新UI顯示

## 重要說明

### 自動化特性
- **完全自動**：無需用戶手動操作
- **實時更新**：標籤信息實時同步
- **智能處理**：自動判斷新舊標籤

### 數據一致性
- **統一類型**：所有標籤統一為"person"類型
- **自動命名**：新標籤自動生成名稱
- **狀態同步**：雲端和本地狀態保持一致

### 性能優化
- **智能過濾**：只處理相關的MQTT消息
- **批量更新**：避免頻繁的狀態更新
- **錯誤處理**：優雅的錯誤處理和恢復

## 未來改進

### 功能增強
- 支持更多標籤類型的自動識別
- 添加標籤分組和分類功能
- 實現標籤歷史軌跡追蹤

### 用戶體驗
- 添加標籤狀態變更通知
- 實現標籤批量操作功能
- 優化標籤搜索和篩選

### 系統集成
- 與其他系統模塊的深度集成
- 支持標籤數據的導出和備份
- 實現標籤使用統計和分析
